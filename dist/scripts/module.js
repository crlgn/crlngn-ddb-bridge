var Re=Object.defineProperty;var Ae=Object.getPrototypeOf;var Se=Reflect.get;var ue=o=>{throw TypeError(o)};var ve=(o,s,e)=>s in o?Re(o,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[s]=e;var D=(o,s,e)=>ve(o,typeof s!="symbol"?s+"":s,e),J=(o,s,e)=>s.has(o)||ue("Cannot "+e);var N=(o,s,e)=>(J(o,s,"read from private field"),e?e.call(o):s.get(o)),H=(o,s,e)=>s.has(o)?ue("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(o):s.set(o,e),F=(o,s,e,t)=>(J(o,s,"write to private field"),t?t.call(o,e):s.set(o,e),e),z=(o,s,e)=>(J(o,s,"access private method"),e);var me=(o,s,e)=>Se(Ae(o),e,s);const ge="crlngn-ddb-bridge",V="crlngn-ddb-bridge",Q=["%cCarolingian DDB Bridge","color: #003377; font-weight: bold;","|"],we=[{abbrev:"str",name:"strength"},{abbrev:"dex",name:"dexterity"},{abbrev:"con",name:"constitution"},{abbrev:"int",name:"intelligence"},{abbrev:"wis",name:"wisdom"},{abbrev:"cha",name:"charisma"}],k={CHAT_MESSAGE:"chatMessage",INIT:"init",READY:"ready",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage",CREATE_CHAT_MESSAGE:"createChatMessage",RENDER_CHAT_MESSAGE:"renderChatMessage",CREATE_MEASURED_TEMPLATE:"createMeasuredTemplate",REFRESH_MEASURED_TEMPLATE:"refreshMeasuredTemplate"},E={PRE_ROLL_V2:"dnd5e.preRollV2",PRE_ROLL_ABILITY_TEST:"dnd5e.preRollAbilityTest",PRE_ROLL_ABILITY_SAVE:"dnd5e.preRollAbilitySave",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrow",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_CLASS_HIT_POINTS:"dnd5e.preRollClassHitPoints",PRE_ROLL_CONCENTRATION:"dnd5e.preRollConcentration",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",PRE_ROLL_DEATH_SAVE:"dnd5e.preRollDeathSave",PRE_ROLL_FORMULA_V2:"dnd5e.preRollFormulaV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",PRE_ROLL_NPC_HIT_POINTS:"dnd5e.preRollNPCHitPoints",PRE_ROLL_RECHARGE_V2:"dnd5e.preRollRechargeV2",PRE_ROLL_SKILL:"dnd5e.preRollSkill",PRE_ROLL_TOOL_CHECK:"dnd5e.preRollToolCheck",PRE_USE_ITEM:"dnd5e.preUseItem",ROLL_ABILITY_TEST:"dnd5e.rollAbilityTest",ROLL_ABILITY_SAVE:"dnd5e.rollAbilitySave",ROLL_ATTACK_V2:"dnd5e.rollAttackV2",ROLL_CLASS_HIT_POINTS:"dnd5e.rollClassHitPoints",ROLL_CONCENTRATION:"dnd5e.rollConcentration",ROLL_DEATH_SAVE:"dnd5e.rollDeathSave",ROLL_DAMAGE_V2:"dnd5e.rollDamageV2",ROLL_FORMULA_V2:"dnd5e.rollFormulaV2",ROLL_HIT_DIE_V2:"dnd5e.rollHitDieV2",ROLL_INITIATIVE:"dnd5e.rollInitiative",ROLL_NPC_HIT_POINTS:"dnd5e.rollNPCHitPoints",ROLL_RECHARGE_V2:"dnd5e.rollRechargeV2",ROLL_SKILL:"dnd5e.rollSkill",ROLL_TOOL_CHECK:"dnd5e.rollToolCheck",DISPLAY_CARD:"dnd5e.preDisplayCardV2",PRE_DISPLAY_CARD_V2:"dnd5e.preDisplayCardV2",RENDER_CHAT_MESSAGE:"dnd5e.renderChatMessage",PRE_LONG_REST:"dnd5e.preLongRest",PRE_REST_COMPLETED:"dnd5e.preRestCmpleted",PRE_SHORT_REST:"dnd5e.preShortRest",REST_COMPLETED:"dnd5e.restCmpleted",ACTIVITY_CONSUMPTION:"dnd5e.activityConsumption",POST_ACTIVITY_CONSUMPTION:"dnd5e.postActivityConsumption",POST_CREATE_USAGE_MESSAGE:"dnd5e.postCreateUsageMessage",POST_USE_ACTIVITY:"dnd5e.postUseActivity",PRE_ACTIVITY_CONSUMPTION:"dnd5e.preActivityConsumption",PRE_CREATE_USAGE_MESSAGE:"dnd5e.preCreateUsageMessage",PRE_USE_ACTIVITY:"dnd5e.preUseActivity"};class he{static registerSettings(){game.settings.register(ge,"debug-mode",{name:"Debug Mode",hint:"Turn on debug messages on browser inspector",default:!1,type:Boolean,scope:"client",config:!0})}static get(s,e=ge){return s?game.settings.get(e,s):null}}class T{static log(s="",e=[],t=!1){(t||he.get("debug-mode"))&&console.log(...Q,s,...e)}static warn(s="",e=[]){console.warn(...Q,s,...e)}static logError(s,e){var t;e.ui&&((t=ui.notifications)==null||t.error(s,{localize:!0,permanent:e.permanent})),e.console&&console.error(...Q,s)}}class v{static getTargets(s){var t;let e=game.user.targets||s.targets||((t=canvas.tokens)==null?void 0:t.controlled);return new Set([...e])}static getTargetDescriptors(){var e,t;const s=new Map;for(const a of game.user.targets){const{name:i}=a,{img:r,system:n,uuid:l,statuses:d}=a.actor??{};if(l){const g=d.has("coverTotal")?null:(t=(e=n.attributes)==null?void 0:e.ac)==null?void 0:t.value;s.set(l,{name:i,img:r,uuid:l,ac:g??null})}}return Array.from(s.values())}static getActorFromItem(s){const e=s.split(".")[1];return game.actors.get(e)}static isModuleOn(s){var t;const e=(t=game.modules)==null?void 0:t.get(s);return!!(e!=null&&e.active)}static parseDDBGLAbility(s){let e=null;const t=`${s}`;return we.forEach(a=>{t.toLowerCase().includes(a.name)&&(e=a)}),e}static isPrivateRoll(s){return s===CONST.DICE_ROLL_MODES.BLIND||s===CONST.DICE_ROLL_MODES.PRIVATE}static removeTemplateForItem(s){const e=canvas.templates.objects.children.filter(t=>t.document.flags.dnd5e.item===s.uuid);canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate",e.map(t=>t.id))}static getItemFromFlavor(s,e){e.flavor}static html(s,e){return s.querySelector(e)}}const h={toHit:{prop:"toHit",cls:"to hit",actionType:"attack",rollType:"attack"},damage:{prop:"damage",cls:"damage",actionType:"damage",rollType:"damage"},heal:{prop:"heal",cls:"heal",actionType:"heal",rollType:"heal"},save:{prop:"save",cls:"save",actionType:"save",rollType:"ability"},check:{prop:"check",cls:"check",actionType:"check",rollType:"ability"},custom:{prop:"custom",cls:"roll",actionType:"roll",rollType:"custom"},cast:{prop:"cast",cls:"cast",actionType:"cast",rollType:"cast"}};class L{static getActivityFromItem(s,e){var d;let t=null;if(!s)return t;const a=(d=s.system)==null?void 0:d.activities,i=s.hasAttack,r=s.hasSave,n=s.hasDamage,l=g=>a.find(c=>c.type===g);switch(e){case h.toHit.cls:t=l(h.toHit.actionType);break;case h.damage.cls:i&&n?t=l(h.toHit.actionType):r&&n?t=l(h.save.actionType):n&&(t=l(h.damage.actionType));break;case h.check.cls:t=l(h.check.actionType);break;case h.save.cls:t=l(h.save.actionType);break;case h.heal.cls:t=l(h.heal.actionType);break;case h.cast.cls:t=l(h.cast.actionType);break}return t??Array.from(a.keys())[0]??null}static async ddbglUse(s,e={},t={},a={},i=!1){var c,u,y,p,f,_;if(!s){ui.notifications.error("No activity found",{localize:!1});return}if(!s.item.isEmbedded||s.item.pack)return;if(!s.item.isOwner){ui.notifications.error("DND5E.DocumentUseWarn",{localize:!0});return}if(!s.canUse){ui.notifications.error("DND5E.ACTIVITY.Warning.UsageNotAllowed",{localize:!0});return}let r=s.item.clone({},{keepId:!0});const n=s._prepareUsageConfig(e);(c=n.create)!=null&&c.measuredTemplate&&((u=ui.notifications)==null||u.info("Click the map to place the template and see the roll. Right click to cancel",{localize:!1}));const l=foundry.utils.mergeObject({configure:!0,applicationClass:s.metadata.usage.dialog},t),d=foundry.utils.mergeObject({create:!0,data:{flags:{dnd5e:{...s.messageFlags,messageType:"usage",use:{effects:(y=s.applicableEffects)==null?void 0:y.map(A=>A.id)}},rsr5e:{processed:!0,quickRoll:!1}}},hasConsumption:n.hasConsumption},a);if(Hooks.call("dnd5e.preUseActivity",s,n,l,d)===!1)return;await s._prepareUsageScaling(n,d,r),s=r.system.activities.get(s.id);const g=await s.consume(n,d);if(g===!1)return;const m={effects:[],templates:[],updates:g};if((p=n.concentration)!=null&&p.begin){const A=await r.actor.beginConcentrating(s,{"flags.dnd5e.scaling":n.scaling});if(A&&(m.effects??(m.effects=[]),m.effects.push(A),foundry.utils.setProperty(d.data,"flags.dnd5e.use.concentrationId",A.id)),(f=n.concentration)!=null&&f.end){const P=await r.actor.endConcentration(n.concentration.end);m.effects.push(...P)}}return d.data.rolls=(d.data.rolls??[]).concat(g.rolls),m.message=await L.createUsageMessage(s,d),m.message.dnd5e=((_=d.flags)==null?void 0:_.dnd5e)??{},m.message.dnd5e.targets=v.getTargetDescriptors(),m.message.flags={...m.message.flags,rsr5e:{processed:!0}},await s._finalizeUsage(n,m),Hooks.call("dnd5e.postUseActivity",s,n,m)===!1||i&&s._triggerSubsequentActions(n,m),m}static async createUsageMessage(s,e){let t=await s._usageChatContext(e),a=await Le(e.data.rolls);t={...t,rolls:a};const i=foundry.utils.mergeObject({rollMode:game.settings.get("core","rollMode"),data:{content:await renderTemplate(s.metadata.usage.chatCard,t),speaker:ChatMessage.getSpeaker({actor:s.item.actor}),flags:{core:{canPopout:!0},rsr5e:{processed:!0}}}},e);Hooks.callAll("dnd5e.preCreateUsageMessage",s,i),ChatMessage.applyRollMode(i.data,i.rollMode);const r=i.create===!1?i.data:await ChatMessage.create(i.data);return Hooks.callAll("dnd5e.postCreateUsageMessage",s,r),r}}const Le=async(o,s)=>{let e=[];return e=await Promise.all(o.map(async t=>{const a=await t.getTooltip();return{...t,formula:t.formula,total:t.total,tooltipHtml:a}})),e},{OperatorTerm:ye,RollTerm:Oe}=foundry.dice.terms;function Z(o,{respectProperties:s}={}){const e=(i,r=[])=>[i,...s?Array.from(r).sort():[]].join(),t=new Map;for(const i of o){if(!i._evaluated)throw new Error("Only evaluated rolls can be aggregated.");for(const r of ke(i.terms,i.options.type)){const n=e(r.type,i.options.properties);t.has(n)||t.set(n,{type:r.type,properties:new Set,terms:[]});const l=t.get(n);l.terms.push(new ye({operator:r.negative?"-":"+"}),...r.terms),i.options.properties&&(l.properties=l.properties.union(new Set(i.options.properties)))}}const a=[];for(const i of t.values()){const r=new CONFIG.Dice.DamageRoll;r.terms=i.terms,r._total=r._evaluateTotal(),r._evaluated=!0,r.options={type:i.type,properties:Array.from(i.properties)},r.resetFormula(),a.push(r)}return a}function ke(o,s){var n;const e=()=>{i.type??(i.type=s),a.push(i),i=null,r=!1},t=l=>l in CONFIG.DND5E.damageTypes||l in CONFIG.DND5E.healingTypes,a=[];let i,r=!1;for(let l of o){if(l instanceof ye&&["+","-"].includes(l.operator)){i&&e(),l.operator==="-"&&(r=!r);continue}l=Oe.fromData(foundry.utils.deepClone(l.toJSON())),i??(i={terms:[],negative:r,type:null}),i.terms.push(l);const d=(n=l.flavor)==null?void 0:n.toLowerCase().trim();t(d)&&(i.type??(i.type=d),l.options.flavor="")}return i&&e(),a}const{ApplicationV2:Me,HandlebarsApplicationMixin:Ie}=foundry.applications.api;class Te extends Ie(Me){get subtitle(){return game.i18n.localize(this.options.window.subtitle??"")}_configureRenderOptions(s){var e;super._configureRenderOptions(s),s.isFirstRender&&this.hasFrame&&(s.window||(s.window={}),(e=s.window).subtitle||(e.subtitle=this.subtitle))}async _prepareContext(s){const e=await super._prepareContext(s);return e.CONFIG=CONFIG.DND5E,e.inputs={...foundry.applications.fields,...dnd5e.applications.fields},e}async _renderFrame(s){var a,i;const e=await super._renderFrame(s),t=document.createElement("h2");if(t.classList.add("window-subtitle"),e.querySelector(".window-title").insertAdjacentElement("afterend",t),(((a=s.window)==null?void 0:a.icon)??"").includes(".")){const r=e.querySelector(".window-icon"),n=document.createElement((i=s.window.icon)!=null&&i.endsWith(".svg")?"dnd5e-icon":"img");n.classList.add("window-icon"),n.src=s.window.icon,r.replaceWith(n)}return e}_updateFrame(s){super._updateFrame(s),s.window&&"subtitle"in s.window&&(this.element.querySelector(".window-header > .window-subtitle").innerText=s.window.subtitle)}_onRender(s,e){super._onRender(s,e),this.element.querySelectorAll("multi-select").forEach(t=>{t.disabled||t.querySelectorAll(".tag").forEach(a=>{var i;a.classList.add("remove"),(i=a.querySelector(":scope > span"))==null||i.classList.add("remove")})}),this.element.querySelectorAll(".label-top > p.hint").forEach(t=>{const a=t.parentElement.querySelector(":scope > label");a&&(t.ariaLabel=t.innerText,t.dataset.tooltip=t.innerHTML,t.innerHTML="",a.insertAdjacentElement("beforeend",t))})}_disableFields(){const s=`.window-content :is(${["INPUT","SELECT","TEXTAREA","BUTTON","DND5E-CHECKBOX","COLOR-PICKER","DOCUMENT-TAGS","FILE-PICKER","HUE-SLIDER","MULTI-SELECT","PROSE-MIRROR","RANGE-PICKER","STRING-TAGS"].join(", ")}):not(.interface-only)`;for(const e of this.element.querySelectorAll(s))e.tagName==="TEXTAREA"?e.readOnly=!0:e.disabled=!0}}D(Te,"DEFAULT_OPTIONS",{classes:["dnd5e2"],window:{subtitle:""}});const{DiceTerm:Pe}=foundry.dice.terms;var M,U,I,q,ie,W,Ee;const $=class $ extends Te{constructor(e={},t={},a={}){super(a);H(this,q);H(this,M);H(this,U);H(this,I);F(this,M,e),F(this,U,t),z(this,q,ie).call(this,foundry.utils.deepClone(N(this,M)))}static get rollType(){return CONFIG.Dice.BasicRoll}get config(){return N(this,M)}get message(){return N(this,U)}get rolls(){return N(this,I)}get rollType(){return this.options.rollType??this.constructor.rollType}_identifyDiceTerms(){let e=[],t=!0;const a=r=>{if(r instanceof Pe){if(!Number.isFinite(r.number)||!Number.isFinite(r.faces)||!this.options.rendering.dice.denominations.has(r.denomination))return t=!1;for(let n=0;n<r.number;n++)e.push({icon:`systems/dnd5e/icons/svg/dice/${r.denomination}.svg`,label:r.denomination,denomination:r.denomination})}},i=(r=[])=>{for(const n of r)a(n),"dice"in n&&i(n.dice)};if(this.rolls.forEach(r=>i(r.terms)),e.length>this.options.rendering.dice.max){const r=e.reduce((n,{icon:l,denomination:d})=>(n[d]??(n[d]={icon:l,count:0}),n[d].count++,n),{});e=Object.entries(r).map(([n,{icon:l,count:d}])=>({icon:l,label:`${d}${n}`})),e.length>this.options.rendering.dice.max&&(t=!1)}else e.length||(t=!1);return t?e:[]}async _preparePartContext(e,t,a){switch(t=await super._preparePartContext(e,t,a),e){case"buttons":return this._prepareButtonsContext(t,a);case"configuration":return this._prepareConfigurationContext(t,a);case"formulas":return this._prepareFormulasContext(t,a);default:return t}}async _prepareButtonsContext(e,t){return e.buttons={roll:{icon:'<i class="fa-solid fa-dice"></i>',label:game.i18n.localize("DND5E.Roll")}},e}async _prepareConfigurationContext(e,t){var a;return e.fields=[{field:new foundry.data.fields.StringField({label:game.i18n.localize("DND5E.RollMode")}),name:"rollMode",value:this.message.rollMode??((a=this.options.default)==null?void 0:a.rollMode),options:Object.entries(CONFIG.Dice.rollModes).map(([i,r])=>({value:i,label:game.i18n.localize(r)}))}],e}async _prepareFormulasContext(e,t){return e.rolls=this.rolls.map(a=>({roll:a})),e.dice=this._identifyDiceTerms()||[],e}_buildConfig(e,t,a){e=foundry.utils.mergeObject({parts:[],data:{},options:{}},e),Hooks.callAll("dnd5e.buildRollConfig",this,e,t,a);const i=t==null?void 0:t.get(`roll.${a}.situational`);return i&&e.situational!==!1?(e.parts.push("@situational"),e.data.situational=i):e.parts.findSplice(r=>r==="@situational"),e}_finalizeRolls(e){return this.rolls}rebuild(){this._onChangeForm(this.options.form,new Event("change"))}_onChangeForm(e,t){super._onChangeForm(e,t);const a=new FormDataExtended(this.element);a.has("rollMode")&&(this.message.rollMode=a.get("rollMode")),z(this,q,ie).call(this,foundry.utils.deepClone(N(this,M)),a),this.render({parts:["formulas"]})}_onClose(e={}){var t;(t=e.dnd5e)!=null&&t.submitted||F(this,I,[])}static async configure(e={},t={},a={}){return new Promise(i=>{const r=new this(e,a,t.options);r.addEventListener("close",()=>i(r.rolls),{once:!0}),r.render({force:!0})})}};M=new WeakMap,U=new WeakMap,I=new WeakMap,q=new WeakSet,ie=function(e,t){var i;const a=this.rollType;F(this,I,((i=e.rolls)==null?void 0:i.map((r,n)=>a.fromConfig(this._buildConfig(r,t,n),this.config)))??[])},W=new WeakSet,Ee=async function(e,t,a){var i,r;F(this,I,this._finalizeRolls((r=(i=e.submitter)==null?void 0:i.dataset)==null?void 0:r.action)),await this.close({dnd5e:{submitted:!0}})},H($,W),D($,"DEFAULT_OPTIONS",{classes:["roll-configuration","standard-form"],tag:"form",window:{title:"DND5E.RollConfiguration.Title",icon:"fa-solid fa-dice",minimizable:!1},form:{handler:z($,W,Ee)},position:{width:400},rendering:{dice:{max:5,denominations:new Set(["d4","d6","d8","d10","d12","d20"])}}}),D($,"PARTS",{formulas:{template:"systems/dnd5e/templates/dice/roll-formulas.hbs"},configuration:{template:"systems/dnd5e/templates/dice/roll-configuration.hbs"},buttons:{template:"systems/dnd5e/templates/dice/roll-buttons.hbs"}});let Y=$;const G=class G extends Y{static get rollType(){return CONFIG.Dice.DamageRoll}async _prepareButtonsContext(s,e){var a;const t=((a=this.config.critical)==null?void 0:a.allow)!==!1;return s.buttons={critical:{icon:'<i class="fa-solid fa-bomb"></i>',label:game.i18n.localize("DND5E.CriticalHit")},normal:{icon:'<i class="fa-solid fa-dice"></i>',label:game.i18n.localize(t?"DND5E.Normal":"DND5E.Roll")}},t||delete s.buttons.critical,s}async _prepareFormulasContext(s,e){s=await super._prepareFormulasContext(s,e);const t=foundry.utils.mergeObject(CONFIG.DND5E.damageTypes,CONFIG.DND5E.healingTypes,{inplace:!1});return s.rolls=s.rolls.map(({roll:a})=>{var i,r;return{roll:a,damageConfig:t[a.options.type]??t[(i=a.options.types)==null?void 0:i[0]],damageTypes:((r=a.options.types)==null?void 0:r.length)>1?Object.entries(t).map(([n,l])=>{var d;return(d=a.options.types)!=null&&d.includes(n)?{value:n,label:l.label}:null}).filter(n=>n):null}}),s}_buildConfig(s,e,t){s=super._buildConfig(s,e,t);const a=e==null?void 0:e.get(`roll.${t}.damageType`);return a&&(s.options.type=a),s}_finalizeRolls(s){return this.rolls.map(e=>(e.options.isCritical=s==="critical",e.configureDamage({critical:this.config.critical}),e))}};D(G,"PARTS",{...me(G,G,"PARTS"),formulas:{template:"systems/dnd5e/templates/dice/damage-formulas.hbs"}});let re=G;function ee(o,s){if(!o)return!1;const e={},t=(a,i)=>{e[a]=i,KeyboardManager.MODIFIER_CODES[a].forEach(r=>e[r]=i)};return t(KeyboardManager.MODIFIER_KEYS.CONTROL,o.ctrlKey||o.metaKey),t(KeyboardManager.MODIFIER_KEYS.SHIFT,o.shiftKey),t(KeyboardManager.MODIFIER_KEYS.ALT,o.altKey),game.keybindings.get("dnd5e",s).some(a=>game.keyboard.downKeys.has(a.key)&&a.modifiers.every(i=>e[i])?!0:a.modifiers.length?!1:e[a.key])}const{DiceTerm:Ne,NumericTerm:He}=foundry.dice.terms,x=class x extends Roll{static fromConfig(s,e){const t=(s.parts??[]).join(" + ");return new this(t,s.data,s.options)}static async build(s={},e={},t={}){var i;this.applyKeybindings(s,e,t);let a;e.configure===!1?a=((i=s.rolls)==null?void 0:i.map(r=>this.fromConfig(r,s)))??[]:a=await(e.applicationClass??this.DefaultConfigurationDialog).configure(s,e,t);for(const r of a)await r.evaluate();return a!=null&&a.length&&t.create!==!1&&await this.toMessage(a,t.data,{rollMode:t.rollMode}),a}static applyKeybindings(s,e,t){e.configure??(e.configure=!0)}get isFailure(){if(this._evaluated)return Number.isNumeric(this.options.target)?this.total<this.options.target:!1}get isSuccess(){if(this._evaluated)return Number.isNumeric(this.options.target)?this.total>=this.options.target:!1}static async toMessage(s,e={},{rollMode:t,create:a=!0}={}){for(const n of s)n._evaluated||await n.evaluate({allowInteractive:t!==CONST.DICE_ROLL_MODES.BLIND}),t??(t=n.options.rollMode);e=foundry.utils.mergeObject({sound:CONFIG.sounds.dice},e),e.rolls=s;const i=getDocumentClass("ChatMessage"),r=new i(e);return a?i.create(r.toObject(),{rollMode:t}):(t&&r.applyRollMode(t),r.toObject())}async evaluate(s={}){return this.preCalculateDiceTerms(s),super.evaluate(s)}evaluateSync(s={}){return this.preCalculateDiceTerms(s),super.evaluateSync(s)}preCalculateDiceTerms(s={}){this._evaluated||!s.maximize&&!s.minimize||(this.terms=this.terms.map(e=>{if(e instanceof Ne&&e.modifiers.length){const t=!s.maximize,a=this.constructor.preCalculateTerm(e,{minimize:t});if(Number.isFinite(a))return new He({number:a,options:e.options})}return e}))}static preCalculateTerm(s,{minimize:e=!1}={}){let t=e?1:s.faces,a=s.number;const i=foundry.utils.deepClone(s.modifiers),r=new Set(["k","kh","kl"]),n=new Set(["d","dh","dl"]),l=new Set([...r,...n,"max","min"]);let d=!1;for(const g of i){const m=/(m[ai][xn]|[kd][hl]?)(\d+)?/i,c=g.match(m);if(!c)continue;c[0].length<c.input.length&&i.push(c.input.slice(c[0].length));let[,u,y]=c;if(u=u.toLowerCase(),!l.has(u))continue;d=!0;const p=parseInt(y)||(u==="max"||u==="min"?-1:1);if(p>0){if(u==="max"&&e||u==="min"&&!e)continue;u==="max"||u==="min"?t=Math.min(s.faces,p):r.has(u)?a=Math.min(a,p):n.has(u)&&(a=Math.max(1,a-p))}}return d?t*a:null}simplify(){var s,e;for(const t of this.dice){const a=t._number;a instanceof x&&a.isDeterministic&&(t._number=a.evaluateSync().total);const i=t._faces;i instanceof x&&i.isDeterministic&&(t._faces=i.evaluateSync().total),(e=(s=i.terms)==null?void 0:s[0])!=null&&e.flavor&&(t.options.flavor=i.terms[0].flavor)}this.resetFormula()}};D(x,"DefaultConfigurationDialog",Y);let ne=x;const{DiceTerm:Fe,FunctionTerm:$e,NumericTerm:fe,OperatorTerm:te,ParentheticalTerm:se,StringTerm:B}=foundry.dice.terms;class le extends ne{constructor(s,e,t){super(s,e,t),this.options.preprocessed||this.preprocessFormula(),this.options.configured||this.configureDamage()}static fromConfig(s,e){const t=super.fromConfig(s,e);return e.critical&&t.configureDamage({critical:e.critical}),t}static async build(s={},e={},t={}){var a,i;return s.critical??(s.critical={}),(a=s.critical).multiplyNumeric??(a.multiplyNumeric=game.settings.get("dnd5e","criticalDamageModifiers")),(i=s.critical).powerfulCritical??(i.powerfulCritical=game.settings.get("dnd5e","criticalDamageMaxDice")),super.build(s,e,t)}static applyKeybindings(s,e,t){var i;const a={normal:ee(s.event,"skipDialogNormal")||ee(s.event,"skipDialogDisadvantage"),critical:ee(s.event,"skipDialogAdvantage")};e.configure??(e.configure=Object.values(a).every(r=>!r));for(const r of s.rolls)r.options??(r.options={}),(i=r.options).isCritical??(i.isCritical=a.critical)}get isCritical(){return this.options.isCritical===!0}preprocessFormula(){for(let[s,e]of this.terms.entries()){const t=this.terms[s+1],a=this.terms[s-1];if(e instanceof B&&/^d\d+/.test(e.term)&&!(a instanceof se)){const i=`1${e.term}`,r=new Roll(i).terms[0];this.terms.splice(s,1,r),e=r}else if(e instanceof se&&a instanceof B&&a.term.match(/^[0-9]*d$/)){if(e.isDeterministic){let i=`${a.term}${e.evaluate().total}`,r=2;t instanceof B&&(i+=t.term,r+=1);const n=new Roll(i).terms[0];this.terms.splice(s-1,r,n),e=n}}else if((e instanceof se||e instanceof $e)&&t instanceof B&&t.term.match(/^d[0-9]*$/)&&e.isDeterministic){const i=`${e.evaluate().total}${t.term}`,r=new Roll(i).terms[0];this.terms.splice(s,2,r),e=r}}this.resetFormula(),this.options.preprocessed=!0}configureDamage({critical:s={}}={}){var t;foundry.utils.mergeObject(s,this.options.critical??{});const e=new Map;for(let[a,i]of this.terms.entries())if(i instanceof Fe){if(i._number instanceof Roll){if(!i._number.isDeterministic)continue;i._number._evaluated||i._number.evaluateSync()}if(i.options.baseNumber=i.options.baseNumber??i.number,i.number=i.options.baseNumber,this.isCritical){let r=s.multiplier??2;if(s.powerfulCritical){const l=Roll.create(i.formula).evaluateSync({maximize:!0}).total;if(l>0){const d=((t=i.flavor)==null?void 0:t.toLowerCase().trim())??game.i18n.localize("DND5E.PowerfulCritical");e.set(d,(e.get(d)??0)+l)}r=Math.max(1,r-1)}let n=s.bonusDice&&a===0?s.bonusDice:0;i.alter(r,n),i.options.critical=!0}}else s.multiplyNumeric&&i instanceof fe&&(i.options.baseNumber=i.options.baseNumber??i.number,i.number=i.options.baseNumber,this.isCritical&&(i.number*=s.multiplier??2,i.options.critical=!0));if(s.powerfulCritical&&e.size)for(const[a,i]of e.entries())this.terms.push(new te({operator:"+"})),this.terms.push(new fe({number:i,options:{flavor:a}}));if(this.isCritical&&s.bonusDamage){const a=new Roll(s.bonusDamage,this.data);a.terms[0]instanceof te||this.terms.push(new te({operator:"+"})),this.terms.push(...a.terms)}this.resetFormula(),this.options.configured=!0}async configureDialog(s={},e={}){return(await this.constructor.configureDialog([this],s,e))[0]??null}static async configureDialog(s,{title:e,defaultRollMode:t,defaultCritical:a=!1,template:i,allowCritical:r=!0}={},n={}){return foundry.utils.logCompatibilityWarning("The `configureDialog` on DamageRoll has been deprecated and is now handled through `DamageRoll.build`.",{since:"DnD5e 4.0",until:"DnD5e 4.4"}),await this.DefaultConfigurationDialog.configure({critical:{allow:r}},{options:{title:e}},{rollMode:t})}}D(le,"DefaultConfigurationDialog",re);const{Coin:Ve,DiceTerm:pe,Die:Ge,FunctionTerm:xe,NumericTerm:j,OperatorTerm:w,ParentheticalTerm:Ce,RollTerm:Ue}=foundry.dice.terms;function be(o,{preserveFlavor:s=!1,deterministic:e=!1}={}){var d;let t;try{t=new Roll(o)}catch(g){console.warn(`Unable to simplify formula '${o}': ${g}`)}if(Roll.validate(t.formula),s||(t.terms=Roll.parse(t.formula.replace(Ue.FLAVOR_REGEXP,""))),e){t.terms=oe(t.terms);const g=[];let m=[],c=!1,u;for(let y=t.terms.length-1;y>=0;){let p,f=t.terms[y];if(f instanceof Ce&&(p=be(f.term,{preserveFlavor:s,deterministic:e})),Number.isNumeric(p)){const _={number:p};s&&(_.options={flavor:f.flavor}),f=new j(_)}for(u=f.isDeterministic&&(!c||u),u?m.unshift(f):m=[],f=t.terms[--y];f instanceof w;){if(u&&m.unshift(f),f.operator==="*"||f.operator==="/"||f.operator==="%")c=!0;else for(c=!1;m.length;)g.unshift(m.pop());f=t.terms[--y]}}if(u)for(;m.length;)g.unshift(m.pop());t.terms=g}if(t.terms=oe(t.terms),/[*/]/.test(t.formula))return t.isDeterministic&&!/d\(/.test(t.formula)&&(!/\[/.test(t.formula)||!s)?String(new Roll(t.formula).evaluateSync().total):t.constructor.getFormula(t.terms);t.terms=De(t.terms),t.terms=Roll.simplifyTerms(t.terms);let{poolTerms:a,diceTerms:i,mathTerms:r,numericTerms:n}=ze(t.terms);n=qe(n??[]),i=Ke(i??[]);const l=[i,a,r,n].flat().filter(Boolean);return((d=l[0])==null?void 0:d.operator)==="+"&&l.shift(),t.constructor.getFormula(l)}function oe(o){return o.reduce((s,e)=>{const t=s[s.length-1],a=new Set([t==null?void 0:t.operator,e.operator]);return a.has(void 0)?s.push(e):a.has("+")&&a.has("-")?s.splice(-1,1,new w({operator:"-"})):a.has("-")&&a.size===1?s.splice(-1,1,new w({operator:"+"})):a.has("+")||s.push(e),s},[])}function qe(o){const s=[],{annotated:e,unannotated:t}=_e(o);if(t.length){const a=Roll.safeEval(Roll.getFormula(t));if(a===0)return[...e];a>0&&s.push(new w({operator:"+"})),s.push(new j({number:a}))}return[...s,...e]}function Ke(o){const{annotated:s,unannotated:e}=_e(o),t=e.reduce((i,r,n)=>{var c;if(r instanceof w)return i;const l=((c=r.constructor)==null?void 0:c.name)==="Coin",d=l?"c":r.faces,g=l?"":r.modifiers.filterJoin(""),m=`${e[n-1].operator}${d}${g}`;return i[m]??(i[m]={}),r._number instanceof Roll&&r._number.isDeterministic&&r._number.evaluateSync(),i[m].number=(i[m].number??0)+r.number,l||(i[m].modifiers=(i[m].modifiers??[]).concat(r.modifiers)),i},{});return[...Object.entries(t).flatMap(([i,{number:r,modifiers:n}])=>[new w({operator:i.charAt(0)}),i.slice(1)==="c"?new Ve({number:r}):new Ge({number:r,faces:parseInt(i.slice(1)),modifiers:[...new Set(n)]})]),...s]}function De(o){return o=o.reduce((s,e)=>{if(e instanceof Ce)if(e.isDeterministic){const t=new Roll(e.term);e=new j({number:t.evaluateSync().total})}else{const t=new Roll(e.term).terms;e=De(t)}return s.push(e),s},[]),oe(o.flat())}function ze(o){return o[0]instanceof w||o.unshift(new w({operator:"+"})),o.reduce((s,e,t)=>{let a;e instanceof pe?a=pe:e instanceof xe&&e.isDeterministic?a=j:a=e.constructor;const i=`${a.name.charAt(0).toLowerCase()}${a.name.substring(1)}s`;return(s[i]=s[i]??[]).push(o[t-1],e),s},{})}function _e(o){return o.reduce((s,e,t)=>(e instanceof w||s[e.flavor?"annotated":"unannotated"].push(o[t-1],e),s),{annotated:[],unannotated:[]})}class ae extends ChatMessage{constructor(){super(...arguments);D(this,"_highlighted",null)}get canApplyDamage(){var t,a,i;const e=(a=(t=this.flags.dnd5e)==null?void 0:t.roll)==null?void 0:a.type;return e&&e!=="damage"?!1:this.isRoll&&this.isContentVisible&&!!((i=canvas.tokens)!=null&&i.controlled.length)}get canSelectTargets(){var e,t;return((t=(e=this.flags.dnd5e)==null?void 0:e.roll)==null?void 0:t.type)!=="attack"?!1:this.isRoll&&this.isContentVisible}get isRoll(){var e;return super.isRoll&&!((e=this.flags.dnd5e)!=null&&e.rest)}get shouldDisplayChallenge(){if(game.user.isGM||this.author===game.user)return!0;switch(game.settings.get("dnd5e","challengeVisibility")){case"all":return!0;case"player":return!this.author.isGM;default:return!1}}static migrateData(e){if(e=super.migrateData(e),foundry.utils.hasProperty(e,"flags.dnd5e.itemData")&&(foundry.utils.setProperty(e,"flags.dnd5e.item.data",e.flags.dnd5e.itemData),delete e.flags.dnd5e.itemData),foundry.utils.hasProperty(e,"flags.dnd5e.use")){const t=e.flags.dnd5e.use;foundry.utils.setProperty(e,"flags.dnd5e.messageType","usage"),t.type&&foundry.utils.setProperty(e,"flags.dnd5e.item.type",t.type),t.itemId&&foundry.utils.setProperty(e,"flags.dnd5e.item.id",t.itemId),t.itemUuid&&foundry.utils.setProperty(e,"flags.dnd5e.item.uuid",t.itemUuid)}return e}prepareData(){super.prepareData(),this._shimFlags(),dnd5e.registry.messages.track(this)}async getHTML(...e){const t=await super.getHTML();return this._displayChatActionButtons(t),this._highlightCriticalSuccessFailure(t),game.settings.get("dnd5e","autoCollapseItemCards")&&t.find(".description.collapsible").each((a,i)=>i.classList.add("collapsed")),this._enrichChatCard(t[0]),this._collapseTrays(t[0]),this._activateActivityListeners(t[0]),Hooks.callAll("dnd5e.renderChatMessage",this,t[0]),t}_collapseTrays(e){let t;switch(game.settings.get("dnd5e","autoCollapseChatTrays")){case"always":t=!0;break;case"never":t=!1;break;case"older":t=this.timestamp<Date.now()-5*60*1e3;break}for(const a of e.querySelectorAll(".card-tray, .effects-tray"))a.classList.toggle("collapsed",t);for(const a of e.querySelectorAll("damage-application, effect-application"))a.toggleAttribute("open",!t)}_displayChatActionButtons(e){var a;const t=e.find(".dnd5e.chat-card, .dnd5e2.chat-card");if(t.length>0){const i=e.find(".flavor-text");i.text()===e.find(".item-name").text()&&i.remove(),this.shouldDisplayChallenge&&(t[0].dataset.displayChallenge="");const r=game.actors.get(this.speaker.actor),n=game.user.isGM||(r==null?void 0:r.isOwner)||this.author.id===game.user.id;for(const l of e[0].querySelectorAll(".card-buttons button"))l.dataset.visibility!=="all"&&(l.dataset.visibility==="gm"&&!game.user.isGM||!n||(a=this.getAssociatedActivity())!=null&&a.shouldHideChatButton(l,this))&&(l.hidden=!0)}}_highlightCriticalSuccessFailure(e){if(!this.isContentVisible||!this.rolls.length)return;const t=this.getOriginatingMessage(),a=t==null?void 0:t.shouldDisplayChallenge,i=game.user.isGM||game.settings.get("dnd5e","attackRollVisibility")!=="none";function r(n){const l=document.createElement("i");return l.classList.add("fas",n),l.setAttribute("inert",""),l}for(let[n,l]of this.rolls.entries()){const d=l.dice[0];if((d==null?void 0:d.faces)!==20||(d==null?void 0:d.values.length)!==1)continue;l=dnd5e.dice.D20Roll.fromRoll(l);const g=l.dice[0];if("success"in g.results[0]||g.options.marginSuccess||g.options.marginFailure)continue;const c=e.find(".dice-total")[n];if(!c)continue;const u=["attack","death"].includes(this.getFlag("dnd5e","roll.type")),p=this.getFlag("dnd5e","roll.type")==="attack"?i:a;g.options.target&&p&&(l.total>=g.options.target?c.classList.add("success"):c.classList.add("failure")),u&&l.isCritical&&c.classList.add("critical"),u&&l.isFumble&&c.classList.add("fumble");const f=document.createElement("div");f.classList.add("icons"),c.classList.contains("critical")?f.append(r("fa-check"),r("fa-check")):c.classList.contains("fumble")?f.append(r("fa-xmark"),r("fa-xmark")):c.classList.contains("success")?f.append(r("fa-check")):c.classList.contains("failure")&&f.append(r("fa-xmark")),f.children.length&&c.append(f)}}_enrichChatCard(e){var f,_,A,P,K,de;const t=this.getAssociatedActor();let a,i;this.isContentVisible?(a=(t==null?void 0:t.img)??this.author.avatar,i=this.alias):(a=this.author.avatar,i=this.author.name);const r=document.createElement("a");r.classList.add("avatar"),t&&(r.dataset.uuid=t.uuid),r.innerHTML=`<img src="${a}" alt="${i}">`;const n=document.createElement("span");n.classList.add("name-stacked"),n.innerHTML=`<span class="title">${i}</span>`;const l=document.createElement("span");l.classList.add("subtitle"),this.whisper.length&&(l.innerText=((f=e.querySelector(".whisper-to"))==null?void 0:f.innerText)??""),i!==((_=this.author)==null?void 0:_.name)&&!l.innerText.length&&(l.innerText=((A=this.author)==null?void 0:A.name)??""),n.appendChild(l);const d=e.querySelector(".message-sender");d==null||d.replaceChildren(r,n),(P=e.querySelector(".whisper-to"))==null||P.remove();const g=e.querySelector(".message-metadata"),m=g.querySelector(".message-delete");game.user.isGM||m==null||m.remove();const c=document.createElement("a");c.setAttribute("aria-label",game.i18n.localize("DND5E.AdditionalControls")),c.classList.add("chat-control"),c.dataset.contextMenu="",c.innerHTML='<i class="fas fa-ellipsis-vertical fa-fw"></i>',g.appendChild(c),e.querySelectorAll("i.dnd5e-icon").forEach(R=>{const O=document.createElement("dnd5e-icon");O.src=R.dataset.src,R.replaceWith(O)});const u=this.getFlag("dnd5e","roll"),y=this.getAssociatedItem(),p=this.getAssociatedActivity();if(this.isContentVisible&&y&&u){const R=u.type==="damage"&&((K=this.rolls[0])==null?void 0:K.isCritical),O=u.type==="damage"?R?game.i18n.localize("DND5E.CriticalHit"):game.i18n.localize("DND5E.DamageRoll"):u.type==="attack"?(p==null?void 0:p.getActionLabel(u.attackMode))??"":((de=y.system.type)==null?void 0:de.label)??game.i18n.localize(CONFIG.Item.typeLabels[y.type]),X=document.createElement("div");X.classList.add("dnd5e2","chat-card"),X.innerHTML=`
        <section class="card-header description ${R?"critical":""}">
          <header class="summary">
            <img class="gold-icon" src="${y.img}" alt="${y.name}">
            <div class="name-stacked">
              <span class="title">${y.name}</span>
              <span class="subtitle">${O}</span>
            </div>
          </header>
        </section>
      `,e.querySelector(".message-header .flavor-text").remove(),e.querySelector(".message-content").insertAdjacentElement("afterbegin",X)}this._enrichAttackTargets(e),this.isContentVisible?(e.querySelectorAll(".dice-tooltip").forEach((R,O)=>{!(u instanceof le)&&this.rolls[O]&&this._enrichRollTooltip(this.rolls[O],R)}),this._enrichDamageTooltip(this.rolls.filter(R=>R instanceof le),e),this._enrichEnchantmentTooltip(e),e.querySelectorAll(".dice-roll").forEach(R=>R.addEventListener("click",this._onClickDiceRoll.bind(this)))):e.querySelectorAll(".dice-roll").forEach(R=>R.classList.add("secret-roll")),this._enrichUsageEffects(e),r.addEventListener("click",this._onTargetMouseDown.bind(this)),r.addEventListener("pointerover",this._onTargetHoverIn.bind(this)),r.addEventListener("pointerout",this._onTargetHoverOut.bind(this))}_enrichRollTooltip(e,t){const a=Number(be(e._formula,{deterministic:!0}));if(!a)return;const i=a<0?"-":"+",r=document.createElement("section");r.classList.add("tooltip-part","constant"),r.innerHTML=`
      <div class="dice">
        <ol class="dice-rolls"></ol>
        <div class="total">
          <span class="value"><span class="sign">${i}</span>${Math.abs(a)}</span>
        </div>
      </div>
    `,t.appendChild(r)}_enrichAttackTargets(e){var g,m;const t=this.rolls[0],a=game.settings.get("dnd5e","attackRollVisibility");if(!(game.user.isGM||a!=="none")||!(t instanceof dnd5e.dice.D20Roll))return;const r=CONFIG.DND5E.weaponMasteries[t.options.mastery];if(r){const c=document.createElement("p");c.classList.add("supplement");let u=r.label;r.reference&&(u=`
        <a class="content-link" draggable="true" data-link data-uuid="${r.reference}"
           data-tooltip="${u}">${u}</a>
      `),c.innerHTML=`<strong>${game.i18n.format("DND5E.WEAPON.Mastery.Flavor")}</strong> ${u}`,(g=e.querySelector(".chat-card")??e.querySelector(".message-content"))==null||g.appendChild(c)}const n=this.getFlag("dnd5e","targets");if(!(n!=null&&n.length))return;const l=document.createElement("div");l.classList.add("dnd5e2"),l.innerHTML=`
      <div class="card-tray targets-tray collapsible collapsed">
        <label class="roboto-upper">
          <i class="fas fa-bullseye" inert></i>
          <span>${game.i18n.localize("DND5E.TargetPl")}</span>
          <i class="fas fa-caret-down" inert></i>
        </label>
        <div class="collapsible-content">
          <ul class="dnd5e2 unlist evaluation wrapper"></ul>
        </div>
      </div>
    `;const d=l.querySelector("ul");d.innerHTML=n.map(({name:c,ac:u,uuid:y})=>{!game.user.isGM&&a!=="all"&&(u="");const p=!t.isCritical&&(t.total<u||t.isFumble);return[`
        <li data-uuid="${y}" class="target ${p?"miss":"hit"}">
          <i class="fas ${p?"fa-times":"fa-check"}"></i>
          <div class="name">${c}</div>
          ${u!==""?`
          <div class="ac">
            <i class="fas fa-shield-halved"></i>
            <span>${u===null?"&infin;":u}</span>
          </div>
          `:""}
        </li>
      `,p]}).sort((c,u)=>c[1]===u[1]?0:c[1]?1:-1).reduce((c,[u])=>c+u,""),d.querySelectorAll("li.target").forEach(c=>{c.addEventListener("click",this._onTargetMouseDown.bind(this)),c.addEventListener("pointerover",this._onTargetHoverIn.bind(this)),c.addEventListener("pointerout",this._onTargetHoverOut.bind(this))}),(m=e.querySelector(".message-content"))==null||m.appendChild(l)}_enrichDamageTooltip(e,t){var m;if(!e.length)return;const a=CONFIG.DND5E.aggregateDamageDisplay?Z(e):e;let{formula:i,total:r,breakdown:n}=a.reduce((c,u)=>(c.formula.push(CONFIG.DND5E.aggregateDamageDisplay?u.formula:` + ${u.formula}`),c.total+=u.total,c.breakdown.push(this._simplifyDamageRoll(u)),c),{formula:[],total:0,breakdown:[]});i=i.join("").replace(/^ \+ /,""),t.querySelectorAll(".dice-roll").forEach(c=>c.remove());const l=document.createElement("div");l.classList.add("dice-roll");const d=n.reduce((c,{type:u,total:y,constant:p,dice:f})=>{const _=CONFIG.DND5E.damageTypes[u]??CONFIG.DND5E.healingTypes[u];return`${c}
        <section class="tooltip-part">
          <div class="dice">
            <ol class="dice-rolls">
              ${f.reduce((A,{result:P,classes:K})=>`
                ${A}<li class="roll ${K}">${P}</li>
              `,"")}
              ${p?`
              <li class="constant"><span class="sign">${p<0?"-":"+"}</span>${Math.abs(p)}</li>
              `:""}
            </ol>
            <div class="total">
              ${_?`<img src="${_.icon}" alt="${_.label}">`:""}
              <span class="label">${(_==null?void 0:_.label)??""}</span>
              <span class="value">${y}</span>
            </div>
          </div>
        </section>
      `},"");l.innerHTML=`
      <div class="dice-result">
        <div class="dice-formula">${i}</div>
        <div class="dice-tooltip-collapser">
          <div class="dice-tooltip">
            ${d}
          </div>
        </div>
        <h4 class="dice-total">${r}</h4>
      </div>
    `,t.querySelector(".message-content").appendChild(l);const g=this.getFlag("dnd5e","roll.damageOnSave");if(g){const c=document.createElement("p");c.classList.add("supplement"),c.innerHTML=`<strong>${game.i18n.format("DND5E.SAVE.OnSave")}</strong> ${game.i18n.localize(`DND5E.SAVE.FIELDS.damage.onSave.${g.capitalize()}`)}`,(m=t.querySelector(".chat-card, .message-content"))==null||m.appendChild(c)}if(game.user.isGM){const c=document.createElement("damage-application");c.classList.add("dnd5e2"),c.damages=Z(e,{respectProperties:!0}).map(u=>({value:u.total,type:u.options.type,properties:new Set(u.options.properties??[])})),t.querySelector(".message-content").appendChild(c)}}_simplifyDamageRoll(e){const t={type:e.options.type,total:e.total,constant:0,dice:[]};let a=!1;for(let i=e.terms.length-1;i>=0;){const r=e.terms[i--];if(!(r instanceof foundry.dice.terms.NumericTerm)&&!(r instanceof foundry.dice.terms.DiceTerm))continue;const n=r.total;r instanceof foundry.dice.terms.DiceTerm&&t.dice.push(...r.results.map(g=>({result:r.getResultLabel(g),classes:r.getResultCSS(g).filterJoin(" ")})));let l=1,d=e.terms[i];for(;d instanceof foundry.dice.terms.OperatorTerm;)["+","-"].includes(d.operator)||(a=!0),d.operator==="-"&&(l*=-1),d=e.terms[--i];r instanceof foundry.dice.terms.NumericTerm&&(t.constant+=n*l)}return a&&(t.constant=null),t}_enrichEnchantmentTooltip(e){var n,l;if(!this.getFlag("dnd5e","use.enchantmentProfile"))return;const a=this.getFlag("dnd5e","use.concentrationId");if(a&&!((n=this.getAssociatedActor())!=null&&n.effects.get(a)))return;const i=document.createElement("enchantment-application");i.classList.add("dnd5e2");const r=e.querySelector(".card-footer");r?r.insertAdjacentElement("beforebegin",i):(l=e.querySelector(".chat-card"))==null||l.append(i)}_enrichUsageEffects(e){var r;const t=this.getAssociatedItem();let a;if(this.getFlag("dnd5e","messageType")==="usage")a=(r=this.getFlag("dnd5e","use.effects"))==null?void 0:r.map(n=>t==null?void 0:t.effects.get(n));else{if(this.getFlag("dnd5e","roll.type"))return;a=t==null?void 0:t.effects.filter(n=>{var l;return n.type!=="enchantment"&&!((l=t.getFlag("dnd5e","riders.effect"))!=null&&l.includes(n.id))})}if(a=a==null?void 0:a.filter(n=>n&&(game.user.isGM||n.transfer&&this.author.id===game.user.id)),!(a!=null&&a.length))return;const i=document.createElement("effect-application");i.classList.add("dnd5e2"),i.effects=a,e.querySelector(".message-content").appendChild(i)}static addChatMessageContextOptions(e,t){const a=([r])=>{var n;return(n=game.messages.get(r.dataset.messageId))==null?void 0:n.canApplyDamage},i=([r])=>{var n;return(n=game.messages.get(r.dataset.messageId))==null?void 0:n.canSelectTargets};return t.push({name:game.i18n.localize("DND5E.ChatContextDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:a,callback:r=>{var n;return(n=game.messages.get(r.data("messageId")))==null?void 0:n.applyChatCardDamage(r,1)},group:"damage"},{name:game.i18n.localize("DND5E.ChatContextHealing"),icon:'<i class="fas fa-user-plus"></i>',condition:a,callback:r=>{var n;return(n=game.messages.get(r.data("messageId")))==null?void 0:n.applyChatCardDamage(r,-1)},group:"damage"},{name:game.i18n.localize("DND5E.ChatContextTempHP"),icon:'<i class="fas fa-user-clock"></i>',condition:a,callback:r=>{var n;return(n=game.messages.get(r.data("messageId")))==null?void 0:n.applyChatCardTemp(r)},group:"damage"},{name:game.i18n.localize("DND5E.ChatContextDoubleDamage"),icon:'<i class="fas fa-user-injured"></i>',condition:a,callback:r=>{var n;return(n=game.messages.get(r.data("messageId")))==null?void 0:n.applyChatCardDamage(r,2)},group:"damage"},{name:game.i18n.localize("DND5E.ChatContextHalfDamage"),icon:'<i class="fas fa-user-shield"></i>',condition:a,callback:r=>{var n;return(n=game.messages.get(r.data("messageId")))==null?void 0:n.applyChatCardDamage(r,.5)},group:"damage"},{name:game.i18n.localize("DND5E.ChatContextSelectHit"),icon:'<i class="fas fa-bullseye"></i>',condition:i,callback:([r])=>{var n;return(n=game.messages.get(r.dataset.messageId))==null?void 0:n.selectTargets(r,"hit")},group:"attack"},{name:game.i18n.localize("DND5E.ChatContextSelectMiss"),icon:'<i class="fas fa-bullseye"></i>',condition:i,callback:([r])=>{var n;return(n=game.messages.get(r.dataset.messageId))==null?void 0:n.selectTargets(r,"miss")},group:"attack"}),t}_activateActivityListeners(e){var t;(t=this.getAssociatedActivity())==null||t.activateChatListeners(this,e)}async _onTargetMouseDown(e){var n;e.stopPropagation();const t=e.currentTarget.dataset.uuid,a=fromUuidSync(t),i=((n=a==null?void 0:a.token)==null?void 0:n.object)??(a==null?void 0:a.getActiveTokens()[0]);if(!i||!a.testUserPermission(game.user,"OBSERVER"))return;const r=!e.shiftKey;if(i.controlled)i.release();else return i.control({releaseOthers:r}),canvas.animatePan(i.center)}_onTargetHoverIn(e){var r;const t=e.currentTarget.dataset.uuid,a=fromUuidSync(t),i=((r=a==null?void 0:a.token)==null?void 0:r.object)??(a==null?void 0:a.getActiveTokens()[0]);i&&i.isVisible&&(i.controlled||i._onHoverIn(e,{hoverOutOthers:!0}),this._highlighted=i)}_onTargetHoverOut(e){this._highlighted&&this._highlighted._onHoverOut(e),this._highlighted=null}applyChatCardDamage(e,t){const a=Z(this.rolls,{respectProperties:!0}).map(i=>({value:i.total,type:i.options.type,properties:new Set(i.options.properties??[])}));return Promise.all(canvas.tokens.controlled.map(i=>{var r;return(r=i.actor)==null?void 0:r.applyDamage(a,{multiplier:t,invertHealing:!1,ignore:!0})}))}selectTargets(e,t){if(!(canvas!=null&&canvas.ready))return;const a=e.closest("[data-message-id]").querySelectorAll(`.evaluation li.target.${t}`),i=new Set(Array.from(a).map(r=>r.dataset.uuid));canvas.tokens.releaseAll(),i.forEach(r=>{var d;const n=fromUuidSync(r);if(!n)return;const l=n.isToken?[(d=n.token)==null?void 0:d.object]:n.getActiveTokens();for(const g of l)g!=null&&g.isVisible&&n.testUserPermission(game.user,"OWNER")&&g.control({releaseOthers:!1})})}applyChatCardTemp(e){const t=this.rolls.reduce((a,i)=>a+i.total,0);return Promise.all(canvas.tokens.controlled.map(a=>{var i;return(i=a.actor)==null?void 0:i.applyTempHP(t)}))}_onClickDiceRoll(e){e.stopPropagation(),e.currentTarget.classList.toggle("expanded")}static onRenderChatPopout(e,[t]){var i;const a=t.querySelector(".header-button.close");a.innerHTML='<i class="fas fa-times"></i>',a.dataset.tooltip=game.i18n.localize("Close"),a.setAttribute("aria-label",a.dataset.tooltip),(i=t.querySelector(".message-metadata [data-context-menu]"))==null||i.remove()}static onRenderChatLog([e]){game.settings.get("dnd5e","autoCollapseItemCards")||requestAnimationFrame(()=>{setTimeout(()=>ui.chat.scrollBottom(),250)})}static activateListeners(){window.addEventListener("keydown",this.toggleModifiers,{passive:!0}),window.addEventListener("keyup",this.toggleModifiers,{passive:!0}),window.addEventListener("blur",()=>this.toggleModifiers({releaseAll:!0}),{passive:!0})}static toggleModifiers({releaseAll:e=!1}={}){document.querySelectorAll(".chat-sidebar > ol").forEach(t=>{for(const a of Object.values(KeyboardManager.MODIFIER_KEYS))game.keyboard.isModifierActive(a)&&!e?t.dataset[`modifier${a}`]="":delete t.dataset[`modifier${a}`]})}_onDelete(e,t){super._onDelete(e,t),dnd5e.registry.messages.untrack(this)}getAssociatedActivity(){var t,a;const e=fromUuidSync(this.getFlag("dnd5e","activity.uuid"));return e||((a=(t=this.getAssociatedItem())==null?void 0:t.system.activities)==null?void 0:a.get(this.getFlag("dnd5e","activity.id")))}getAssociatedActor(){if(this.speaker.scene&&this.speaker.token){const e=game.scenes.get(this.speaker.scene),t=e==null?void 0:e.tokens.get(this.speaker.token);if(t)return t.actor}return game.actors.get(this.speaker.actor)}getAssociatedItem(){const e=fromUuidSync(this.getFlag("dnd5e","item.uuid"));if(e)return e;const t=this.getAssociatedActor();if(!t)return;const a=this.getFlag("dnd5e","item.data")??this.getOriginatingMessage().getFlag("dnd5e","item.data");if(a)return new Item.implementation(a,{parent:t})}getAssociatedRolls(e){return dnd5e.registry.messages.get(this.id,e)}getOriginatingMessage(){return game.messages.get(this.getFlag("dnd5e","originatingMessage"))??this}_shimFlags(){var t;const e=foundry.utils.getProperty(this,"flags.dnd5e");if((e==null?void 0:e.messageType)==="usage"&&(e!=null&&e.use)){const a="The item data in the `dnd5e.use` flag on `ChatMessage` is now `dnd5e.item.type`, `dnd5e.item.id`, and `dnd5e.item.uuid`. Checking for usage can now be done using the `dnd5e.messageType` flag.";Object.defineProperty(e.use,"type",{get(){var i;return foundry.utils.logCompatibilityWarning(a,{since:"DnD5e 4.0",until:"DnD5e 4.4",once:!0}),(i=e.item)==null?void 0:i.type},configurable:!0,enumerable:!1}),Object.defineProperty(e.use,"itemId",{get(){var i;return foundry.utils.logCompatibilityWarning(a,{since:"DnD5e 4.0",until:"DnD5e 4.4",once:!0}),(i=e.item)==null?void 0:i.id},configurable:!0,enumerable:!1}),Object.defineProperty(e.use,"itemUuid",{get(){var i;return foundry.utils.logCompatibilityWarning(a,{since:"DnD5e 4.0",until:"DnD5e 4.4",once:!0}),(i=e.item)==null?void 0:i.uuid},configurable:!0,enumerable:!1})}else if((e==null?void 0:e.messageType)==="roll"&&(e!=null&&e.roll)){const a="The item data in the `dnd5e.roll` flag on `ChatMessage` is now `dnd5e.item.id` and `dnd5e.item.uuid`.";Object.defineProperty(e.roll,"itemId",{get(){var i;return foundry.utils.logCompatibilityWarning(a,{since:"DnD5e 4.0",until:"DnD5e 4.4",once:!0}),(i=e.item)==null?void 0:i.id},configurable:!0,enumerable:!1}),Object.defineProperty(e.roll,"itemUuid",{get(){var i;return foundry.utils.logCompatibilityWarning(a,{since:"DnD5e 4.0",until:"DnD5e 4.4",once:!0}),(i=e.item)==null?void 0:i.uuid},configurable:!0,enumerable:!1})}(t=e==null?void 0:e.item)!=null&&t.data&&Object.defineProperty(e,"itemData",{get(){return foundry.utils.logCompatibilityWarning("The `dnd5e.itemData` flag on `ChatMessage` is now `dnd5e.item.data`.",{since:"DnD5e 4.0",until:"DnD5e 4.4",once:!0}),this.item.data},configurable:!0,enumerable:!1})}}const C=class C{static resetRollGetters(s){return s._total=s._evaluateTotal(),s.resetFormula(),s}static replaceTerms(s,e){return s.terms=e.terms,s._total=s._evaluateTotal(),s.resetFormula(),s}};D(C,"streamlineDDBRoll",async(s,e,t,a)=>{let i=null;T.log("streamlineDDBRoll",[s,e,{...t},a]);let r={},n=t.rolls[0];switch(r.dialog={configure:!1},r.roll={formula:n.formula,consume:{resources:!1,spellSlot:!1},rolls:[],flags:{...t.flags,[V]:{processed:!1},dnd5e:{...t.flags.dnd5e},rsr5e:{processed:!0,quickRoll:!1}}},t.flags=r.roll.flags,r.message={flavor:t.flavor,speaker:t.speaker,whisper:t.whisper,user:game.user,blind:t.blind||v.isPrivateRoll(a.rollMode),rollMode:a.rollMode},!0){case s===h.toHit.cls:i=L.getActivityFromItem(e,s)??null,await C.triggerAttack(i,t,a,r);break;case s===h.damage.cls:i=L.getActivityFromItem(e,s)??null,await C.triggerDamage(i,t,a,r);break;case(s===h.save.cls||s===h.check.cls):i=null,await C.triggerAbilityTest(s,t,a,r);break;case s===h.heal.cls:i=L.getActivityFromItem(e,s)??null,await C.triggerHeal(i,t,a,r);break;case s===h.custom.cls:i=null,await C.triggerCustomRoll(r);break}}),D(C,"triggerAttack",async(s,e,t,a)=>{let i;if(!s)throw new Error("No associated activity found.");a.roll.flags.dnd5e.roll={type:"attack"},a.roll.flags.rsr5e={processed:!0},a.roll.flags.dnd5e.targets=v.getTargetDescriptors(),a.message.flags=a.roll.flags;let r=await s.rollAttack(a.roll,a.dialog,{create:!1});if(r.length<1)return;C.replaceTerms(r[0],e.rolls[0]);const n=s.metadata.usage.chatCard;s.metadata.usage.chatCard=`modules/${V}/templates/ddb-attack-info.hbs`,i=await L.ddbglUse(s,a.roll,a.dialog,{create:!1,data:{rollMsg:e.content,rolls:r,flags:{rsr5e:a.roll.flags.rsr5e,[V]:{processed:!1,rollMode:t.rollMode,cls:e.flags["ddb-game-log"].cls,flavor:`<span class="crlngn item-name">${s.item.name}:</span> <span class="crlngn ${e.flags["ddb-game-log"].cls.replace(" ","")}">${e.flags["ddb-game-log"].cls}</span>`}}}}),i.message.rolls=r,i.message.flags.dnd5e.targets=v.getTargetDescriptors(),i.message.flags=i.message.flags??{},T.log("USAGE RESULTS",[i]),await ae.create(i.message,{rollMode:t.rollMode}),s.metadata.usage.chatCard=n}),D(C,"triggerDamage",async(s,e,t,a)=>{let i;if(!s)throw new Error("No associated activity found for "+item.name);s.attack||(i=await L.ddbglUse(s,a.roll,a.dialog,{create:!1}),T.log("ACTIVITY",[i]),await ae.create(i.message,{rollMode:t.rollMode}));let r=await s.rollDamage(a.roll,a.dialog,{create:!1});r.length<1||(C.replaceTerms(r[0],e.rolls[0]),i||(i={message:a.message}),i.message.rolls=r,i.message.flags=i.message.flags??{},i.message.flags.rsr5e={processed:!0,quickRoll:!1},a.roll.flags.dnd5e.targets=v.getTargetDescriptors(),a.message.flags=a.roll.flags,await r[0].toMessage(a.message),s.attack||game.user.targets.forEach(n=>{n.actor.testUserPermission(game.user,"OWNER")&&n.control({releaseOthers:!1})}),setTimeout(()=>{v.removeTemplateForItem(s.item)},2500))}),D(C,"triggerAbilityTest",async(s,e,t,a)=>{const i=v.parseDDBGLAbility(e.flags["ddb-game-log"].flavor);let r;a.roll.flags.dnd5e.roll={type:s===h.check.cls?"ability":"save"},i&&(a.roll.flags.dnd5e.roll.ability=i.abbrev),a.message.flags=a.roll.flags,s===h.save.cls?r=await t.actor.rollSavingThrow({ability:i==null?void 0:i.abbrev},a.dialog,{create:!1}):s===h.check.cls&&(r=await t.actor.rollAbilityCheck({ability:i==null?void 0:i.abbrev},a.dialog,{create:!1})),!(r.length<1)&&(C.replaceTerms(r[0],e.rolls[0]),await r[0].toMessage(a.message))}),D(C,"triggerHeal",async(s,e,t,a)=>{let i;if(!s)throw new Error("No associated activity found for "+ddbglCls);i=await L.ddbglUse(s,a.roll,a.dialog,{create:!1}),T.log("ACTIVITY",[i]),await ae.create(i.message,{rollMode:t.rollMode});let r=await s.rollDamage(a.roll,a.dialog,{create:!1,data:{flags:a.message.flags}});r.length<1||(C.replaceTerms(r[0],e.rolls[0]),i||(i={message:a.message}),i.message.rolls=r,i.message.flags=i.message.flags??{},i.message.flags.rsr5e={processed:!0,quickRoll:!1},a.roll.flags.dnd5e.targets=v.getTargetDescriptors(),a.message.flags=a.roll.flags,await r[0].toMessage(a.message))}),D(C,"triggerCustomRoll",async(s,e)=>{s.message.flags=s.roll.flags,await e.rolls[0].toMessage(s.message)});let ce=C;const b=class b{static init(){b.registerHooks()}static registerHooks(){Hooks.once(k.INIT,()=>{b.registerActivityHooks(),b.registerRollHooks(),b.registerChatHooks(),b.registerTemplateHooks(),he.registerSettings(),b.isMidiOn=v.isModuleOn("midi-qol"),T.log("Initiating module",[CONFIG,b.isMidiOn],null,!0)})}static registerActivityHooks(){Hooks.on(E.PRE_USE_ACTIVITY,Be),Hooks.on(E.POST_USE_ACTIVITY,Ye)}static registerRollHooks(){Hooks.on(E.ROLL_ATTACK_V2,st),Hooks.on(E.ROLL_DAMAGE_V2,tt),Hooks.on(E.PRE_ROLL_V2,Je),Hooks.on(E.PRE_ROLL_ATTACK_V2,Ze),Hooks.on(E.PRE_ROLL_DAMAGE_V2,et),Hooks.on(E.PRE_ROLL_SAVING_THROW,Qe)}static registerChatHooks(){Hooks.on(E.RENDER_CHAT_MESSAGE,Xe),Hooks.on(k.PRE_CREATE_CHAT_MESSAGE,We),Hooks.on(k.CREATE_CHAT_MESSAGE,je)}static registerTemplateHooks(){Hooks.on(k.REFRESH_MEASURED_TEMPLATE,at)}static setupKeyListeners(){window.addEventListener("keydown",s=>{const e=s.key;b.keysPressed.indexOf(e)<0&&b.keysPressed.push(e),T.log("Keydown",[b.keysPressed])}),window.addEventListener("keyup",s=>{const e=s.key,t=b.keysPressed.indexOf(e);t>=0&&b.keysPressed.splice(t,1),T.log("Keyup",[b.keysPressed])})}};D(b,"keysPressed",[]),D(b,"isMidiOn",!1);let S=b;const Be=async(o,s,e,t)=>(S.keysPressed.indexOf("Shift")==-1?e.configure=!1:e.configure=!0,T.log(E.PRE_USE_ACTIVITY,[o,s,e,t,S.keysPressed]),!0),Ye=async(o,s,e)=>(T.log(E.POST_USE_ACTIVITY,[o,s,e]),!0),We=(o,s,e,t)=>{var m,c;let a=!1,i,r,n,l,d=!1;const g={...o};return r=o.getFlag("ddb-game-log","cls"),d=o.getFlag(V,"processed")||!1,T.log(k.PRE_CREATE_CHAT_MESSAGE,[r,o,{...s},e]),r&&!d&&(a=!0,i=s.actor||null,n=((c=(m=s.flags)==null?void 0:m["ddb-game-log"])==null?void 0:c.itemId)||"",g.flags={...g.flags,...s.flags},g.flags[V]&&(g.flags[V].processed=!0,d=!0),T.log(k.PRE_CREATE_CHAT_MESSAGE+" B",[s,g,S.isMidiOn]),i&&(l=n?i.items.find(u=>u.id==n):"",ce.streamlineDDBRoll(r,l,g,s))),!a||d},je=(o,s,e)=>{T.log(k.CREATE_CHAT_MESSAGE,[o,s,e])},Xe=(o,s)=>{let e=s.querySelector(".message-sender .subtitle"),t=s.querySelector(".message-sender .flavor-text"),a=s.querySelector(".message-header .flavor-text");s.classList.remove("ddb-game-log-open-card");const i=(a==null?void 0:a.innerHTML)||"";T.log(E.RENDER_CHAT_MESSAGE,[i,o,s,s.querySelector(".message-header .flavor-text")]),i!==""&&(e&&(e.innerHTML=i),t&&(t.innerHTML=i))},Je=(o,s,e)=>{T.log(E.PRE_ROLL_V2,[o,s,e]),s.configure=!1},Qe=(o,s,e)=>{T.log(E.PRE_ROLL_SAVING_THROW,[o,s,e])},Ze=(o,s,e)=>(T.log(E.PRE_ROLL_ATTACK_V2,[o,s,e,S.keysPressed]),S.keysPressed.indexOf("Shift")==-1&&(s.configure=!1),!0),et=(o,s,e)=>(T.log(E.PRE_ROLL_DAMAGE_V2,[o,s,e,S.keysPressed]),S.keysPressed.indexOf("Shift")==-1&&(s.configure=!1),!0),tt=(o,s,e)=>{T.log(E.ROLL_DAMAGE_V2,[game])},st=async(o,s)=>{T.log(E.ROLL_ATTACK_V2,[o,s])},at=(o,s)=>{var e;if(o.isOwner){(e=canvas.tokens.placeables[0])==null||e.setTarget(!1,{releaseOthers:!0});for(let t of canvas.tokens.placeables)o.shape.contains(t.center.x-o.x,t.center.y-o.y)&&t.setTarget(!t.isTargeted,{releaseOthers:!1})}};S.init();
//# sourceMappingURL=module.js.map
