var P=Object.defineProperty;var H=(a,e,t)=>e in a?P(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var y=(a,e,t)=>H(a,typeof e!="symbol"?e+"":e,t);const E={toHit:{label:"to hit",activityType:"attack",rollType:"attack"},damage:{label:"damage",activityType:"attack",rollType:"damage"},heal:{label:"heal",activityType:"heal",rollType:"heal"},save:{label:"save",activityType:"",rollType:"ability"},check:{label:"check",activityType:"",rollType:"skill"}},S="crlgn-rolls",I=["%cCrlgn Rolls","color: #003377; font-weight: bold;","|"],k={attack:"attack"},u={CHAT_MESSAGE:"chatMessage",INIT:"init",READY:"ready",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage",RENDER_CHAT_MESSAGE:"renderChatMessage"},_={PRE_ROLL_ABILITY_TEST:"dnd5e.preRollAbilityTest",PRE_ROLL_ABILITY_SAVE:"dnd5e.preRollAbilitySave",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_CLASS_HIT_POINTS:"dnd5e.preRollClassHitPoints",PRE_ROLL_CONCENTRATION:"dnd5e.preRollConcentration",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",PRE_ROLL_DEATH_SAVE:"dnd5e.preRollDeathSave",PRE_ROLL_FORMULA_V2:"dnd5e.preRollFormulaV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",PRE_ROLL_NPC_HIT_POINTS:"dnd5e.preRollNPCHitPoints",PRE_ROLL_RECHARGE_V2:"dnd5e.preRollRechargeV2",PRE_ROLL_SKILL:"dnd5e.preRollSkill",PRE_ROLL_TOOL_CHECK:"dnd5e.preRollToolCheck",PRE_USE_ITEM:"dnd5e.preUseItem",ROLL_ABILITY_TEST:"dnd5e.rollAbilityTest",ROLL_ABILITY_SAVE:"dnd5e.rollAbilitySave",ROLL_ATTACK_V2:"dnd5e.rollAttackV2",ROLL_CLASS_HIT_POINTS:"dnd5e.rollClassHitPoints",ROLL_CONCENTRATION:"dnd5e.rollConcentration",ROLL_DEATH_SAVE:"dnd5e.rollDeathSave",ROLL_DAMAGE_V2:"dnd5e.rollDamageV2",ROLL_FORMULA_V2:"dnd5e.rollFormulaV2",ROLL_HIT_DIE_V2:"dnd5e.rollHitDieV2",ROLL_INITIATIVE:"dnd5e.rollInitiative",ROLL_NPC_HIT_POINTS:"dnd5e.rollNPCHitPoints",ROLL_RECHARGE_V2:"dnd5e.rollRechargeV2",ROLL_SKILL:"dnd5e.rollSkill",ROLL_TOOL_CHECK:"dnd5e.rollToolCheck",DISPLAY_CARD:"dnd5e.preDisplayCardV2",PRE_DISPLAY_CARD_V2:"dnd5e.preDisplayCardV2",RENDER_CHAT_MESSAGE:"dnd5e.renderChatMessage",PRE_LONG_REST:"dnd5e.preLongRest",PRE_REST_COMPLETED:"dnd5e.preRestCmpleted",PRE_SHORT_REST:"dnd5e.preShortRest",REST_COMPLETED:"dnd5e.restCmpleted",ACTIVITY_CONSUMPTION:"dnd5e.activityConsumption",POST_ACTIVITY_CONSUMPTION:"dnd5e.postActivityConsumption",POST_CREATE_USAGE_MESSAGE:"dnd5e.postCreateUsageMessage",POST_USE_ACTIVITY:"dnd5e.postUseActivity",PRE_ACTIVITY_CONSUMPTION:"dnd5e.preActivityConsumption",PRE_CREATE_USAGE_MESSAGE:"dnd5e.preCreateUsageMessage",PRE_USE_ACTIVITY:"dnd5e.preUseActivity"};class O{static getTargets(e){let t=game.user.targets||e.targets||game.user.selected||e.selected||[];return new Set([...t])}static getTargetDescriptors(){var t,l;const e=new Map;for(const R of game.user.targets){const{name:c}=R,{img:n,system:r,uuid:i,statuses:d}=R.actor??{};if(i){const o=d.has("coverTotal")?null:(l=(t=r.attributes)==null?void 0:t.ac)==null?void 0:l.value;e.set(i,{name:c,img:n,uuid:i,ac:o??null})}}return Array.from(e.values())}static isModuleOn(e){var l;return!!((l=game.modules)==null?void 0:l.get(e))}}class s{static log(e="",t=[]){console.log(...I,e,...t)}static warn(e="",t=[]){console.warn(...I,e,...t)}static logError(e,t){t.ui&&console.log(ui.notifications),t.console&&console.error(...I,e)}}class f{static init(){}static async fastForwardActivity(e,t){switch(t={...t,dialog:{...t.dialog,configure:!1},msg:{...t.msg,create:!0}},s.log("RollUtil.fastForwardActivity",[e.type,t]),e.type){case k.attack:const l=await e.rollAttack(t.usage||{},t.dialog||{},t.msg||{});s.log("ActivityUtil.fastForwardActivity - rolls",[l]);break;default:s.log("ActivityUtil.fastForwardActivity - Activity not configured",[])}}}y(f,"forwardAction",async(e,t,l,R)=>{var g,A,L;let c=[],n=null;s.log("forwardAction",[{...l},R]);let r,i,d,o,T;switch(e){case E.toHit.label:n=t.find(C=>C.type===E.toHit.activityType),r=l.rolls[0],i={configure:!1},d={rolls:[r],formula:r.formula,flags:{...l.flags,[S]:{originalRoll:[r],temporary:!0},dnd5e:{...l.flags.dnd5e,messageType:"roll",roll:{type:"attack"},targets:O.getTargetDescriptors()}}},o=await n.rollAttack(d,i,{create:!1}),o[0].terms=r.terms,o[0]._total=o[0]._evaluateTotal(),o[0].resetFormula(),T={rolls:o,formula:o[0].formula,flavor:l.flavor,speaker:l.speaker,whisper:l.whisper,user:game.user,blind:l.blind,flags:{...l.flags,[S]:{originalRoll:[r]},dnd5e:{...l.flags.dnd5e,messageType:"roll",roll:{type:"attack"},targets:O.getTargetDescriptors()}}},await o[0].toMessage(T);break;case E.damage.label:n=t.find(C=>C.type===E.toHit.activityType),s.log("forwardAction - "+E.damage.label,[l.rolls]),r=l.rolls[0],i={configure:!1},d={rolls:[r],flags:{...l.flags,[S]:{originalRoll:[r],temporary:!0},dnd5e:{...l.flags.dnd5e,messageType:"roll",roll:{type:"damage"},targets:O.getTargetDescriptors(),scaling:((g=l.flags.dnd5e)==null?void 0:g.scaling)??0}},isCritical:((A=l.flags["ddb-game-log"])==null?void 0:A.isCritical)??!1,scaling:((L=l.flags.dnd5e)==null?void 0:L.scaling)??0},i={configure:!1},s.log("DamageRoll",[game.dnd5e.dice.DamageRoll]),o=await n.rollDamage({isCritical:d.isCritical,scaling:d.scaling},i,{create:!1,data:{flags:d.flags}}),o[0].terms=r.terms,o[0]._total=o[0]._evaluateTotal(),o[0].resetFormula(),T={rolls:o,formula:o[0].formula,flavor:l.flavor,speaker:l.speaker,whisper:l.whisper,user:game.user,blind:l.blind,flags:{...l.flags,[S]:{originalRoll:[r]},dnd5e:{...l.flags.dnd5e,messageType:"roll",roll:{type:"damage"},targets:O.getTargetDescriptors()}}},await o[0].toMessage(T),s.log("forwardAction - "+E.damage,[T]);break}return n||(c=Array.from(t),c[0]||null)});class p{static registerHooks(){Hooks.once(u.INIT,()=>{s.log("Initiating module",[CONFIG]),p.registerActivityHooks(),p.registerRollHooks(),p.registerChatHooks()})}static registerActivityHooks(){Hooks.on(_.PRE_USE_ACTIVITY,D),Hooks.on(_.POST_USE_ACTIVITY,V)}static registerRollHooks(){Hooks.on(_.ROLL_ATTACK_V2,U),Hooks.on(_.PRE_ROLL_ATTACK_V2,M),Hooks.on(_.PRE_ROLL_DAMAGE_V2,N)}static registerChatHooks(){Hooks.on(_.RENDER_CHAT_MESSAGE,v),Hooks.on(u.PRE_CREATE_CHAT_MESSAGE,m)}}const D=async(a,e,t,l)=>(t&&(t.configure=!1),s.log(_.PRE_USE_ACTIVITY,[a,e,t,l]),!0),V=async(a,e,t)=>(s.log(_.POST_USE_ACTIVITY,[a,e,t]),!0),m=(a,e,t,l)=>{var g,A,L;let R=!1,c,n,r,i,d,o;const T={...a};return r=a.getFlag("ddb-game-log","cls"),o=a.getFlag(S,"originalRoll"),s.log(u.PRE_CREATE_CHAT_MESSAGE,[a,r]),r&&!o&&(R=!0,n=e.actor,i=((A=(g=e.flags)==null?void 0:g["ddb-game-log"])==null?void 0:A.itemId)||"",s.log(u.PRE_CREATE_CHAT_MESSAGE,[n,i]),n&&i&&(d=n.items.find(C=>C.id==i),c=((L=d==null?void 0:d.system)==null?void 0:L.activities)||null,s.log("activities",[i,c]),c&&f.forwardAction(r,c,T,e))),!R},v=(a,e,t,l)=>{s.log(_.RENDER_CHAT_MESSAGE,[a,e,t,l])},M=(a,e,t)=>(s.log(_.PRE_ROLL_ATTACK_V2,[a,e,t]),e.configure=!1,!0),N=(a,e,t)=>(s.log(_.PRE_ROLL_DAMAGE_V2,[a,e,t]),e.configure=!1,!0),U=async(a,e)=>{s.log(_.ROLL_ATTACK_V2,[a,e])};p.registerHooks();
//# sourceMappingURL=module.js.map
